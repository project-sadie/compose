$ErrorActionPreference = "Stop"

if (-Not (Test-Path "/etc/os-release")) {
    Write-Output "Cannot determine OS. /etc/os-release not found."
    exit 1
}

$osRelease = Get-Content /etc/os-release | ForEach-Object {
    $parts = $_ -split '='
    if ($parts.Length -eq 2) {
        @{ ($parts[0]) = $parts[1] }
    }
} | Merge-Hashtable

if ($osRelease["ID"].Trim('"') -ne "ubuntu") {
    Write-Output "This script is intended for Ubuntu only. Detected OS: $($osRelease["ID"])"
    exit 1
}

if (-Not (Get-Command docker -ErrorAction SilentlyContinue)) {
    Write-Output "Docker not found. Installing Docker and Docker Compose plugin..."
    sudo apt-get update
    sudo apt-get install -y ca-certificates curl gnupg lsb-release
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    $arch = $(dpkg --print-architecture)
    $codename = $(lsb_release -cs)
    $repo = "deb [arch=$arch signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $codename stable"
    $repo | sudo tee /etc/apt/sources.list.d/docker.list > $null
    sudo apt-get update
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    Write-Output "Docker and Docker Compose plugin installed successfully."
} else {
    Write-Output "Docker is already installed."
}

if (-Not (docker compose version 2>$null)) {
    Write-Output "Docker Compose plugin not found. Trying to install..."
    sudo apt-get install -y docker-compose-plugin
}

git clone https://github.com/project-sadie/www ../www
git clone https://github.com/project-sadie/api ../api
git clone https://github.com/project-sadie/SadieEmulator ../SadieEmulator
git clone https://github.com/billsonnn/nitro-react ../nitro-react

mv ../nitro-react/public/renderer-config.json.example ../nitro-react/public/renderer-config.json
mv ../nitro-react/public/ui-config.json.example ../nitro-react/public/ui-config.json

(Get-Content ../nitro-react/public/renderer-config.json) -replace 'website\.com', 'cdn.sadie.pw' | Set-Content ../nitro-react/public/renderer-config.json

mv ../SadieEmulator/Sadie.Console/appsettings.json.example ../SadieEmulator/Sadie.Console/appsettings.json

(Get-Content ../SadieEmulator/Sadie.Console/appsettings.json) `
    -replace 'Pwd=;', 'Pwd=secret;' `
    -replace 'Server=127\.0\.0\.1;', 'Server=mariadb;' | Set-Content ../SadieEmulator/Sadie.Console/appsettings.json

docker compose up --detach
