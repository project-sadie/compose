$ErrorActionPreference = "Stop"

if (-Not (Get-Command docker -ErrorAction SilentlyContinue)) {
    Write-Output "Docker is not installed. Installing Docker Desktop using winget..."
    
    if (-Not (Get-Command winget -ErrorAction SilentlyContinue)) {
        Write-Output "winget is not installed. Please install it manually or use another method."
        exit 1
    }

    winget install -e --id Docker.DockerDesktop

    Write-Output "Please restart your system and re-run this script after Docker Desktop installation."
    exit 0
} else {
    Write-Output "Docker is already installed."
}

if (-Not (docker compose version 2>$null)) {
    Write-Output "Docker Compose plugin appears to be missing. Please ensure Docker Desktop is updated."
}

git clone https://github.com/project-sadie/www ../www
git clone https://github.com/project-sadie/api ../api
git clone https://github.com/project-sadie/SadieEmulator ../SadieEmulator
git clone https://github.com/billsonnn/nitro-react ../nitro-react

Move-Item ../nitro-react/public/renderer-config.json.example ../nitro-react/public/renderer-config.json -Force
Move-Item ../nitro-react/public/ui-config.json.example ../nitro-react/public/ui-config.json -Force

(Get-Content ../nitro-react/public/renderer-config.json) -replace 'website\.com', 'cdn.sadie.pw' | Set-Content ../nitro-react/public/renderer-config.json

Move-Item ../SadieEmulator/Sadie.Console/appsettings.json.example ../SadieEmulator/Sadie.Console/appsettings.json -Force

(Get-Content ../SadieEmulator/Sadie.Console/appsettings.json) `
    -replace 'Pwd=;', 'Pwd=secret;' `
    -replace 'Server=127\.0\.0\.1;', 'Server=mariadb;' | Set-Content ../SadieEmulator/Sadie.Console/appsettings.json

docker compose up --detach

